name: K2P Ad Enhanced 5.4 Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo apt clean
          df -h

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential flex bison g++ gawk \
            gettext git libncurses-dev libssl-dev \
            rsync unzip zlib1g-dev file wget curl \
            python3 python3-setuptools

      - name: Clone OpenWrt 21.02 (Linux 5.4)
        run: |
          git clone --depth 1 -b openwrt-21.02 \
          https://github.com/openwrt/openwrt.git
          mv openwrt firmware

      - name: Add Adbyby Feed
        run: |
          cd firmware
          echo "src-git helloworld https://github.com/fw876/helloworld" >> feeds.conf.default

      - name: Update Feeds
        run: |
          cd firmware
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load K2P Config
        run: |
          cp configs/k2p-ad-enhanced.config firmware/.config
          cd firmware
          make defconfig

      - name: Download Packages
        run: |
          cd firmware
          make download -j8

      - name: Compile Firmware
        run: |
          cd firmware
          make -j$(nproc)

      - name: Generate Checksums
        run: |
          cd firmware/bin/targets/*/*
          sha256sum *.bin > sha256.txt

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: k2p-5.4-ad-enhanced
          path: firmware/bin/targets/*/*